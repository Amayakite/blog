---
title: 01-微服务
date: 2022-1-2 18:31:06
category: 分布式-微服务
tag:
- 微服务
- SpringCloud
---

## 概述

这是Java中和多线程一样让人头秃的东西

微服务是一种加加购模式

它提倡将单一应用程序划分成一组小的服务，服务之间互相协调，互相配合，为用户提供最终价值

每个服务运行在其独立的进程中，服务与服务间才用轻量级的通信机制互相协作（通常是基于Http或者RestFul API）

每个服务都围绕着具体一个服务而言，应根据业务上下文，选择合适的语言、工具对齐进行构建

之前是一个Java程序做所有的事情，微服务就是让这些程序完全解耦合……

就相当于于是用Spring Boot 开发一个一个的单元 通过某个东西 只对外暴露一个借口 然后他们这些单元之间互相通信、互相协调

![image-20220102193132217](/images/SpringCloud/01-微服务/image-20220102193132217.png)

![image-20220102193239296](/images/SpringCloud/01-微服务/image-20220102193239296.png)

Spring Cloud的功能

协调、构建、组装一切

![image-20220102193311042](/images/SpringCloud/01-微服务/image-20220102193311042.png)



以下维度的广泛的技术共同构成了分布式微服务加购的体系

这玩意并不是说强在某一个点，而是整个体系

![image-20220102193356963](/images/SpringCloud/01-微服务/image-20220102193356963.png)

> SpringCloud= 分布式微服务架构的一站式解决方案，是多种微服务加购落地技术的结合体，俗称微服务全家桶

你猜猜这个SpringCloud这个大集合里有多少种技术

emmm我是猜不出

![image-20220102193934628](/images/SpringCloud/01-微服务/image-20220102193934628.png)

它有20个

其中有一些已经过时了，例如第三个还是哪一个，取而替代的是国内最牛逼的分布式框架---阿里巴巴的Nacos

SpringCloud已经成为了微服务开发的主流技术栈

下面是2018年京东的促销节用到的技术栈

![image-20220102194227543](/images/SpringCloud/01-微服务/image-20220102194227543.png)

再来看看阿里的

![image-20220102194341608](/images/SpringCloud/01-微服务/image-20220102194341608.png)

和京东物流架构

![image-20220102194357557](/images/SpringCloud/01-微服务/image-20220102194357557.png)

接下来看一套基础的分布式加购

![image-20220102194449855](/images/SpringCloud/01-微服务/image-20220102194449855.png)



微服务目前大致要求的技术栈为

![image-20220102194622604](/images/SpringCloud/01-微服务/image-20220102194622604.png)

也就是

![image-20220102194759135](/images/SpringCloud/01-微服务/image-20220102194759135.png)

当然 这些都是在2020年之前的固定技术栈，在这之后几乎每一个技术都有所变更了

做好准备。这是就业的必经阶段…

### 关于SpringCloud版本的选择

先看[官网](https://spring.io/projects/spring-cloud#overview)

截至目前 我这里的SpringCloud是2021.0.0

Spring Boot的版本是2.6.2

![image-20220102200426337](/images/SpringCloud/01-微服务/image-20220102200426337.png)

![image-20220102200445869](/images/SpringCloud/01-微服务/image-20220102200445869.png)

所以我用最新版的就可以

但是 这玩意每个版本之间都有不同的地方 所以用的时候估计有蛮多坑

### 更具体的依赖选型

访问这个[地址](https://start.spring.io/actuator/info)

你可以看到所有的依赖需要的对应版本

![image-20220102201812695](/images/SpringCloud/01-微服务/image-20220102201812695.png)

md 忒多了

而且。。。。这玩意还有很多不兼容的地方

我待会先尝试最新的版本，不行的话就换成最稳的2.5~2.6之间的版本

```json
{
    "git": {
        "branch": "dc8e0454e3d0299e7002610a3f82af001013e959",
        "commit": {
            "id": "dc8e045",
            "time": "2022-01-02T10:10:06Z"
        }▸
    },▸
    "build": {
    "version": "0.0.1-SNAPSHOT",
    "artifact": "start-site",
    "versions": {
    "spring-boot": "2.6.2",
    "initializr": "0.12.0-SNAPSHOT"
},▸
"name": "start.spring.io website",
"time": "2022-01-02T10:11:21.501Z",
"group": "io.spring.start"
},▸
"bom-ranges": {
    "azure": {
        "3.2.0": "Spring Boot >=2.3.0.M1 and <2.4.0-M1",
        "3.5.0": "Spring Boot >=2.4.0.M1 and <2.5.0-M1",
        "3.10.0": "Spring Boot >=2.5.0.M1 and <2.6.0-M1"
    },▸
    "codecentric-spring-boot-admin": {
    "2.4.3": "Spring Boot >=2.3.0.M1 and <2.5.0-M1",
    "2.5.5": "Spring Boot >=2.5.0.M1 and <2.6.0-M1"
},▸
"solace-spring-boot": {
    "1.1.0": "Spring Boot >=2.3.0.M1 and <2.6.0-M1"
},▸
"solace-spring-cloud": {
    "1.1.1": "Spring Boot >=2.3.0.M1 and <2.4.0-M1",
    "2.1.0": "Spring Boot >=2.4.0.M1 and <2.6.0-M1"
},▸
"spring-cloud": {
    "Hoxton.SR12": "Spring Boot >=2.2.0.RELEASE and <2.4.0.M1",
    "2020.0.5": "Spring Boot >=2.4.0.M1 and <2.6.0-M1",
    "2021.0.0-M1": "Spring Boot >=2.6.0-M1 and <2.6.0-M3",
    "2021.0.0-M3": "Spring Boot >=2.6.0-M3 and <2.6.0-RC1",
    "2021.0.0-RC1": "Spring Boot >=2.6.0-RC1 and <2.6.1",
    "2021.0.0": "Spring Boot >=2.6.1 and <2.6.3-SNAPSHOT",
    "2021.0.1-SNAPSHOT": "Spring Boot >=2.6.3-SNAPSHOT and <2.7.0-M1"
},▸
"spring-cloud-gcp": {
    "2.0.7": "Spring Boot >=2.4.0-M1 and <2.6.0-M1"
},▸
"spring-cloud-services": {
    "2.3.0.RELEASE": "Spring Boot >=2.3.0.RELEASE and <2.4.0-M1",
    "2.4.1": "Spring Boot >=2.4.0-M1 and <2.5.0-M1",
    "3.3.0": "Spring Boot >=2.5.0-M1 and <2.6.0-M1"
},▸
"spring-geode": {
    "1.3.12.RELEASE": "Spring Boot >=2.3.0.M1 and <2.4.0-M1",
    "1.4.13": "Spring Boot >=2.4.0-M1 and <2.5.0-M1",
    "1.5.7": "Spring Boot >=2.5.0-M1 and <2.6.0-M1",
    "1.6.1": "Spring Boot >=2.6.0-M1 and <2.7.0-M1"
},▸
"vaadin": {
    "14.8.1": "Spring Boot >=2.1.0.RELEASE and <2.8.0-M1"
},▸
"wavefront": {
    "2.0.2": "Spring Boot >=2.1.0.RELEASE and <2.4.0-M1",
    "2.1.1": "Spring Boot >=2.4.0-M1 and <2.5.0-M1",
    "2.2.2": "Spring Boot >=2.5.0-M1 and <2.7.0-M1"
}▸
},▸
"dependency-ranges": {
    "native": {
        "0.9.0": "Spring Boot >=2.4.3 and <2.4.4",
        "0.9.1": "Spring Boot >=2.4.4 and <2.4.5",
        "0.9.2": "Spring Boot >=2.4.5 and <2.5.0-M1",
        "0.10.0": "Spring Boot >=2.5.0-M1 and <2.5.2",
        "0.10.1": "Spring Boot >=2.5.2 and <2.5.3",
        "0.10.2": "Spring Boot >=2.5.3 and <2.5.4",
        "0.10.3": "Spring Boot >=2.5.4 and <2.5.5",
        "0.10.4": "Spring Boot >=2.5.5 and <2.5.6",
        "0.10.5": "Spring Boot >=2.5.6 and <2.5.9-SNAPSHOT",
        "0.10.6-SNAPSHOT": "Spring Boot >=2.5.9-SNAPSHOT and <2.6.0-M1",
        "0.11.0-M1": "Spring Boot >=2.6.0-M1 and <2.6.0-RC1",
        "0.11.0-M2": "Spring Boot >=2.6.0-RC1 and <2.6.0",
        "0.11.0-RC1": "Spring Boot >=2.6.0 and <2.6.1",
        "0.11.0": "Spring Boot >=2.6.1 and <2.6.2",
        "0.11.1": "Spring Boot >=2.6.2 and <2.6.3-SNAPSHOT",
        "0.11.2-SNAPSHOT": "Spring Boot >=2.6.3-SNAPSHOT and <2.7.0-M1"
    },▸
    "okta": {
    "1.4.0": "Spring Boot >=2.2.0.RELEASE and <2.4.0-M1",
    "1.5.1": "Spring Boot >=2.4.0-M1 and <2.4.1",
    "2.0.1": "Spring Boot >=2.4.1 and <2.5.0-M1",
    "2.1.4": "Spring Boot >=2.5.0-M1 and <2.6.0-M1"
},▸
"mybatis": {
    "2.1.4": "Spring Boot >=2.1.0.RELEASE and <2.5.0-M1",
    "2.2.1": "Spring Boot >=2.5.0-M1"
},▸
"camel": {
    "3.5.0": "Spring Boot >=2.3.0.M1 and <2.4.0-M1",
    "3.10.0": "Spring Boot >=2.4.0.M1 and <2.5.0-M1",
    "3.13.0": "Spring Boot >=2.5.0.M1 and <2.6.0-M1",
    "3.14.0": "Spring Boot >=2.6.0.M1 and <2.7.0-M1"
},▸
"picocli": {
    "4.6.2": "Spring Boot >=2.4.0.RELEASE and <2.6.0-M1"
},▸
"open-service-broker": {
    "3.2.0": "Spring Boot >=2.3.0.M1 and <2.4.0-M1",
    "3.3.1": "Spring Boot >=2.4.0-M1 and <2.5.0-M1",
    "3.4.0-M2": "Spring Boot >=2.5.0-M1 and <2.6.0-M1"
}▸
}▸
}▸
```

### Cloud内停用的组件

只能说 在最开始提到的那些几乎全军覆没

画❌的全都挂了，画✔的是现在可以用且推荐用的

![image-20220102204212918](/images/SpringCloud/01-微服务/image-20220102204212918.png)

服务配置里面貌似还有一个阿波罗apollo 据说也很好用 不过目前国内几乎都是阿里的Nacos的天下

可以看到 七个席位，阿里巴巴占了三个席位，太顶了卧槽

当然 这些都是2018~2020年的变化，现在是2022年1月2日20:46:34

没准今明两年又有新的东西出现

## 准备工作

先做一个简单的订单生成系统

我们先创建一个空的maven project

接着把src删掉

![image-20220102211146883](/images/SpringCloud/01-微服务/image-20220102211146883.png)

因为我们之后是要模块化开发 一个project内包含多个module 所以得删掉这个src

### 添加总依赖

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <!--    设置打包名称-->
    <packaging>pom</packaging>
    <modules>
        <module>cloud-provider-payment8001</module>
    </modules>

    <groupId>com.amayakite</groupId>
    <artifactId>30-cloud</artifactId>
    <version>1.0-SNAPSHOT</version>

    <!--    统一管理Jar包版本-->
    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <spring.cloud-version>2020.0.5</spring.cloud-version>
        <spring.boot.version>2.5.8</spring.boot.version>
        <spring.boot.alibaba.version>2021.1</spring.boot.alibaba.version>
        <mysql.version>8.0.27</mysql.version>
        <druid-spring-boot-starter.version>1.2.8</druid-spring-boot-starter.version>
        <junit.version>5.8.2</junit.version>
        <mybatis.plus.version>3.4.3.4</mybatis.plus.version>
        <lombok.version>1.18.22</lombok.version>
    </properties>


    <!--    引入依赖dependencyManagement 是锁定版本 让子工程不用写groupId和version -->
    <dependencyManagement>
        <dependencies>
            <!--            spring boot 版本控制-->
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-parent</artifactId>
                <version>${spring.boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <!--            spring cloud 版本控制-->
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring.cloud-version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>${spring.boot.alibaba.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>mysql</groupId>
                <artifactId>mysql-connector-java</artifactId>
                <version>${mysql.version}</version>
            </dependency>
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>druid-spring-boot-starter</artifactId>
                <version>${druid-spring-boot-starter.version}</version>
            </dependency>
            <dependency>
                <groupId>com.baomidou</groupId>
                <artifactId>mybatis-plus-boot-starter</artifactId>
                <version>${mybatis.plus.version}</version>
            </dependency>
            <!--junit-->
            <dependency>
                <groupId>org.junit.jupiter</groupId>
                <artifactId>junit-jupiter</artifactId>
                <version>${junit.version}</version>
                <scope>test</scope>
            </dependency>
            <dependency>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
                <version>${lombok.version}</version>
            </dependency>

        </dependencies>


    </dependencyManagement>

</project>
```

### 创建子项目，并添加依赖

添加一个子项目 会自动继承父项目 我们只需要添加对应的依赖即可

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>30-cloud</artifactId>
        <groupId>com.amayakite</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>cloud-provider-payment8001</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

<!--        注意这个玩意 后面非常重要 通常和web一块出现-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid-spring-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jdbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
        </dependency>
    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <fork>true</fork>
                    <addResources>true</addResources>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
```

### 准备数据库

```sql
create table payment
(
    id     bigint(20) primary key auto_increment comment 'id',
    serial varchar(200) default ''
);
```

### 配置spring boot

```yaml
# 更该端口
server:
  port: 8001
# 开个debug
logging.level.com.Project: debug
spring:
#  应用名称
  application:
    name: cloud-provider-payment-8001
#  数据库相关配置
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/cloud
    username: root
    password: 123456

mybatis-plus:
#  扫mapper.xml
  mapper-locations: ["classpath*:/mapper/**/*.xml"]
#  扫描的包

```

main：

```java
@SpringBootApplication
@MapperScan("com.Project.mapper") // 扫描mapper
public class Application {
    public static void main(String[] args) {
        ConfigurableApplicationContext run = SpringApplication.run(Application.class, args);
    }
}

```

然后用那啥mybatis x 生成一下对应的玩意

### 准备返回值统一类-ResponseResult

```java
package com.Project.domain;

import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.AllArgsConstructor;
import lombok.Data;
import org.springframework.http.HttpStatus;

/**
 * @author Amayakite
 * @version 1.0.0
 * @BelongsProject 30-cloud
 * @BelongsPackage com.Project.domain
 * @date 2022/1/2 22:44
 * @description 返回值统一处理
 * @since 1.8
 */
@Data
@AllArgsConstructor
@JsonInclude(JsonInclude.Include.NON_NULL)
public class ResponseResult<T> {
    /**
     * 状态码
     */
    private Integer code;

    /**
     * 提示信息
     */
    private String msg;

    /**
     * 查询到的结果
     */
    private T data;

    public ResponseResult(Integer code) {
        this.code = code;
    }

    public ResponseResult(Integer code, T data) {
        this.code = code;
        this.data = data;
    }

    public ResponseResult(Integer code, String msg) {
        this.code = code;
        this.msg = msg;
    }

    public ResponseResult(HttpStatus httpStatus) {
        this.code = httpStatus.value();
        this.msg = httpStatus.getReasonPhrase();
    }


}

```

### 准备接口并测试

```java
@RestController
@Slf4j
@RequestMapping("/payment")
public class HelloController {
    @GetMapping("/hello")
    public ResponseResult<String> hello() {
        return new ResponseResult<>(HttpStatus.OK);
    }

    @Autowired
    PaymentService paymentService;

    @PostMapping("/create/{payment}")
    public ResponseResult<Payment> create(@PathVariable("payment") String payment) {
        log.info("支付信息：{}", payment);
        if (StringUtils.isEmpty(payment)) {
            return new ResponseResult<>(HttpStatus.BAD_REQUEST);
        }
        Payment payment1 = new Payment(payment);
        boolean save = paymentService.save(payment1);
        if (save) {
            return new ResponseResult<>(200, "ok", payment1);
        } else {
            return new ResponseResult<>(HttpStatus.BAD_REQUEST);
        }
    }

    @GetMapping("/query")
    public ResponseResult<List<Payment>> query() {
        LambdaQueryWrapper<Payment> query = new LambdaQueryWrapper<>();
        query.eq(Payment::getId, 1);
        Map<String, Object> map = paymentService.getMap(query);
        log.info("查询结果：{}", map);
        return new ResponseResult<List<Payment>>(200, "ok", paymentService.list());
    }

    @GetMapping("/payment/get/{id}")
    public ResponseResult<Payment> getPayment(@PathVariable("id") Long id) {
        Payment byId = paymentService.getById(id);
        if (byId != null) {
            return new ResponseResult<>(200, "ok", byId);
        }

        return new ResponseResult<>(HttpStatus.BAD_REQUEST);
    }

}
```

## 扩展-使用swagger替代PostMan

由于potman来测试接口稍微有那么亿点点痛苦

并且这玩意是基于Electron写的 就像是Vscode那样 开多了电脑扛不住

所以这种更方便的玩意就来了

这玩意有两个特点

- 号称是实际上最流行的API框架
- RestFul Api文档的在线自动生成工具
  - API文档和API定义同步更新
- 直接运行，可以在线测试API接口
- 支持多种语言（Java、PHP。。。）

官网地址<https://swagger.io/>

### 添加依赖和简单使用

使用很简单

导入一个依赖即可

注意 3 和 2的配置不一样

详情可以看这篇文章<https://blog.csdn.net/weixin_43740223/article/details/108491386>

这里的`springfox-swagger.version`我的是3.0.0

```xml
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-boot-starter</artifactId>
    <version>${springfox-swagger.version}</version>
</dependency>
```

父工程添加完毕后 子工程添加

```xml
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-boot-starter</artifactId>
</dependency>
```

速度可能比较慢 这玩意依赖蛮多jar包

接着我们需要在application内添加@EnableOpenApi注解 否则无法使用

```java {3}
@SpringBootApplication
@MapperScan("com.Project.mapper")
@EnableOpenApi
public class Application {
    public static void main(String[] args) {
        ConfigurableApplicationContext run = SpringApplication.run(Application.class, args);
    }
}

```

接着我的端口是<http://localhost:8001>，所以只需要访问<http://localhost:8001/swagger-ui>

即可

![image-20220103132647337](/images/SpringCloud/01-微服务/image-20220103132647337.png)

将可以看到如上页面

感觉不好看的话

可以添加一个配置文件

```java
@Configuration
public class SwaggerConfig {

    @Bean
    public Docket docket() {
        Docket docket = new Docket(DocumentationType.OAS_30).apiInfo(
            new ApiInfoBuilder()
            .contact(new Contact("Amayakite", "", "amayakite@qq.com"))
            .title("Swagger 项目")
            .build()
        );
        return docket;
    }

}

```

重启后访问

![image-20220103133101899](/images/SpringCloud/01-微服务/image-20220103133101899.png)





如果感觉这个页面不美观的话

可以添加第三方依赖包 这是貌似是GitHhub开发的

```xml
<dependency>
    <groupId>com.github.xiaoymin</groupId>
    <artifactId>swagger-bootstrap-ui</artifactId>
    <version>1.9.6</version>
</dependency>
```

然后重启 不对 先看看这玩意的res在哪

![image-20220103133601706](/images/SpringCloud/01-微服务/image-20220103133601706.png)

貌似直接访问doc.html即可

重启后访问下:

![image-20220103133617930](/images/SpringCloud/01-微服务/image-20220103133617930.png)

这才舒服嘛

### Docket的配置一览

除了之前的简单配置之外 还可以这样配置

```java
@Bean
public Docket docket() {
    return new Docket(DocumentationType.OAS_30).apiInfo(
        new ApiInfoBuilder()
        .contact(new Contact("Amayakite", "", "amayakite@qq.com"))
        .title("Swagger 项目")
        .description("这里填写座右铭")
        .version("1.0.0")
        .termsOfServiceUrl("https://amayakite.github.io")
        .license("Apache 2.0")
        .licenseUrl("http://www.apache.org/licenses/LICENSE-2.0.html")
        .build()
    );
}

```

效果

![image-20220103143708702](/images/SpringCloud/01-微服务/image-20220103143708702.png)

![image-20220103143716675](/images/SpringCloud/01-微服务/image-20220103143716675.png)

如果说只要在生产环境下使用这个 只需要

![image-20220103161150529](/images/SpringCloud/01-微服务/image-20220103161150529.png)

配置文件中设置下即可 然后用spring的

```yaml
 spring:
     profiles:
        # 测试环境
        active: prod

```

制定完毕后 在哦创建一个指定的application-prod.xxx即可

一般情况下 都有现成的模板 不需要自己写

### 配置API文档

这个非常简单 不多说了 详细看[这篇文章](https://blog.csdn.net/github_38823514/article/details/88970607?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-2.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-2.no_search_link&utm_relevant_index=3)

```java
用于注解pojo的两个
@ApiModel(description = "Content类描述")
public class Content {
@ApiModelProperty("标题")
    private String title;
    
用于控制器类(Controller)的3个
@Api(tags = {"Index控制器"}) // tags是对Controller的接口重新分类
@Controller
public class IndexController {
    @ApiOperation("getContent方法")
    @GetMapping("/test")
    @ResponseBody
    public Content getContent(@ApiParam("名字") @RequestParam String name) {
```



实体类

```java
@Data
@AllArgsConstructor
@JsonInclude(JsonInclude.Include.NON_NULL)
@ApiModel(value = "ResponseResult", description = "返回结果")
public class ResponseResult<T> {
    /**
     * 状态码
     */
    @ApiModelProperty(value = "状态码", name = "code", example = "200", required = true)
    private Integer code;

    /**
     * 提示信息
     */
    @ApiModelProperty(value = "提示信息", name = "msg", example = "成功", required = true)
    private String msg;

    /**
     * 查询到的结果
     */
    @ApiModelProperty(value = "查询到的结果", name = "data", example = "", required = false)
    private T data;

    public ResponseResult(Integer code) {
        this.code = code;
    }

    public ResponseResult(Integer code, T data) {
        this.code = code;
        this.data = data;
    }

    public ResponseResult(Integer code, String msg) {
        this.code = code;
        this.msg = msg;
    }

    public ResponseResult(HttpStatus httpStatus) {
        this.code = httpStatus.value();
        this.msg = httpStatus.getReasonPhrase();
    }


}

```

接口

```java
@RestController
@Slf4j
@Api(tags = "支付接口")
@RequestMapping("/payment")
public class HelloController {


    @Autowired
    PaymentService paymentService;

    @ApiOperation("测试")
    @GetMapping("/hello")
    public ResponseResult<String> hello() {
        return new ResponseResult<>(HttpStatus.OK);
    }

    @ApiOperation("添加支付")
    @PostMapping("/create/{payment}")
    public ResponseResult<Payment> create(@ApiParam("账单名") @PathVariable("payment") String payment) {
        log.info("支付信息：{}", payment);
        if (StringUtils.isEmpty(payment)) {
            return new ResponseResult<>(HttpStatus.BAD_REQUEST);
        }
        Payment payment1 = new Payment(payment);
        boolean save = paymentService.save(payment1);
        if (save) {
            return new ResponseResult<>(200, "ok", payment1);
        } else {
            return new ResponseResult<>(HttpStatus.BAD_REQUEST);
        }
    }


    @GetMapping("/query")
    public ResponseResult<List<Payment>> query() {
        LambdaQueryWrapper<Payment> query = new LambdaQueryWrapper<>();
        query.eq(Payment::getId, 1);
        Map<String, Object> map = paymentService.getMap(query);
        log.info("查询结果：{}", map);
        return new ResponseResult<List<Payment>>(200, "ok", paymentService.list());
    }

    @GetMapping("/payment/get/{id}")
    public ResponseResult<Payment> getPayment(@PathVariable("id") Long id) {
        Payment byId = paymentService.getById(id);
        if (byId != null) {
            return new ResponseResult<>(200, "ok", byId);
        }

        return new ResponseResult<>(HttpStatus.BAD_REQUEST);
    }

}
```

效果

![image-20220103164227248](/images/SpringCloud/01-微服务/image-20220103164227248.png)

### 生产环境下关闭

3.x只需要在配置文件内加上

```yaml
springfox:
  documentation:
    swagger-ui:
      enabled: false
    enabled: false
```

注意 如果使用了第三方的UI的话 这样不管用 没有解决方法

2.x的话 

```java
/**
 * Swagger2 接口配置
 */

@Configuration
@EnableSwagger2
//@Profile({"dev","test"})
@ConditionalOnProperty(name = "swagger.enable", havingValue = "true")
public class Swagger2Config {
    /**
     * 添加摘要信息(Docket)
     */
    @Bean
    public Docket controllerApi() {
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(new ApiInfoBuilder()
                        .title("标题：某公司_用户信息管理系统_接口文档")
                        .description("描述：用于管理集团旗下公司的人员信息,具体包括XXX,XXX模块...")
                        .contact(new Contact("Socks", null, null))
                        .version("版本号:1.0")
                        .build())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.hehe.controller"))
                .paths(PathSelectors.any())
                .build();
    }
}
```

2.x也可以直接修改UI页面 加一个ajax验证之类的。。

## 准备工作2-消费者

![image-20220103165959311](/images/SpringCloud/01-微服务/image-20220103165959311.png)

县传建一个module 然后注入如下依赖

不需要sql

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>30-cloud</artifactId>
        <groupId>com.amayakite</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <artifactId>cloud-consumer-order-80</artifactId>
    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-configuration-processor</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>

```

接下来修改下端口

```properties
server.port=80
```

然后把两个实体类COPY一份过来

![image-20220103171358431](/images/SpringCloud/01-微服务/image-20220103171358431.png)

### 使用RestTemplate来完成两个进程的沟通

这玩意是基于HttpClient封装的

HttpClient 可以理解为 Java中的axios 就像是Python的Requests包那样 可以发送Http请求

这玩意使用起来非常的简单粗暴

有三个参数

- url 请求地址
- requestMap 请求参数
- ResponseBean.class 响应后被转换成的对象类型

这玩意属于web包，只需要简单的加一个Bean就可以使用了

```java
@Configuration
public class ApplicationConfig {

    @Bean
    @ConditionalOnMissingBean
    public RestTemplate getRestTemplate(){
        return new RestTemplate();
    }
}

```

ConditionalOnMissingBean 防止重复添加

接着使用 注意 **如果返回是List 一定要用Collection接收** 不然有概率出问题

```java
@RestController()
@RequestMapping("/consumer")
public class OrderController {

    private static final String Payment_URL = "http://localhost:8001";

    @Autowired
    private RestTemplate restTemplate;

    @PostMapping("/payment/create/{paymentName}")
    public ResponseResult<Payment> create(@PathVariable("paymentName") String paymentName) {
        return restTemplate.postForObject(Payment_URL + "/payment/create/" + paymentName, null, ResponseResult.class);
    }

    @GetMapping("/payment")
    public ResponseResult<Collection<Payment>> getPayment() {
//        注意这个 Collection 非常重要 可以预防list和map的类型转换异常
        return restTemplate.getForObject(Payment_URL + "/payment/query",
//                指定是ResponseResult<List<Payment>>类型
                ResponseResult.class
        );
    }


}

```

之后当你常启动的时候或者在创建项目的时候 右下角应该会弹出一个 提示是否开启service的玩意

反正看到了一个设置的按钮就点true即可

![image-20220103180800149](/images/SpringCloud/01-微服务/image-20220103180800149.png)

启动后是这个样子

测试：

![image-20220103180829971](/images/SpringCloud/01-微服务/image-20220103180829971.png)

![image-20220103180836359](/images/SpringCloud/01-微服务/image-20220103180836359.png)

如果说没看到那啥的话 就点开这个然后自己整两下即可

![image-20220103181008523](/images/SpringCloud/01-微服务/image-20220103181008523.png)



## 目前项目中的问题及解决

我们貌似已经完成了一个微服务的搭建

但貌似它还存在一些问题

- 系统中含有重复部分：例如我们的两个domain 和类似的Controller
  - 是不是应该移动到一个公用的工程来供他们使用

为此 我们可以新建一个工程cloud-api-commons 把这些东西都以到这个公共工程内

![image-20220103182917525](/images/SpringCloud/01-微服务/image-20220103182917525.png)

依赖只需要一个lombok和一个hutool

```xml
<dependencies>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
    <dependency>
        <groupId>cn.hutool</groupId>
        <artifactId>hutool-all</artifactId>
        <version>5.7.18</version>
    </dependency>
</dependencies>
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-annotations</artifactId>
</dependency>

```

当然 后面见到什么黄了 就那啥倒入什么

hutool迟早要用到 不如直接放在公用的包内

jackson不解释 反序列化要用

接着 将那两个domain移动到这个包内 没错 移动到

ResponseResult里面还有个方法要依赖springweb 所以也导入下

![image-20220103184035722](/images/SpringCloud/01-微服务/image-20220103184035722.png)

接下来该怎么使用呢？

非常简单…

只需要在其他包内添加Maven依赖即可

```xml
<dependency>
    <groupId>你的项目名，IDEA理论上会自动的补全</groupId>
    <artifactId>cloud-api-commons</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

然后看见那里红了改哪里即可（注意 mapper也要更改对应的路径）

最终结构：

![image-20220103184412969](/images/SpringCloud/01-微服务/image-20220103184412969.png)

三个不标红就算成功

接着我们一键启动服务看看效果

![image-20220103184609009](/images/SpringCloud/01-微服务/image-20220103184609009.png)

接着测试

![image-20220103184917970](/images/SpringCloud/01-微服务/image-20220103184917970.png)

发现ID有问题

这个是因为我们的mapper没有跟过去 所以要把mybatis也导入那

接着测试

PS：需要先修改下自增长的值 不然等下还是重刚刚那个店来继续走的

```sql
alter table payment AUTO_INCREMENT=3;
```

接着测试：通过

![image-20220103190106055](/images/SpringCloud/01-微服务/image-20220103190106055.png)

查询也是正常的

![image-20220103190138289](/images/SpringCloud/01-微服务/image-20220103190138289.png)

我们目前的项目结构应该是这样的

```md
├─cloud-api-commons
│  └─src
│      ├─main
│      │  ├─java
│      │  │  └─com
│      │  │      └─Project
│      │  │          └─commons
│      │  │              └─domain
│      │  └─resources
│      └─test
│          └─java
├─cloud-consumer-order-80
│  ├─src
│  │  ├─main
│  │  │  ├─java
│  │  │  │  └─com
│  │  │  │      └─example
│  │  │  │          └─cloudconsumerorder80
│  │  │  │              ├─config
│  │  │  │              └─controller
│  │  │  └─resources
│  │  │      ├─static
│  │  │      └─templates
│  │  └─test
│  │      └─java
│  │          └─com
│  │              └─example
│  │                  └─cloudconsumerorder80
│  └─target
│      ├─classes
│      │  └─com
│      │      └─example
│      │          └─cloudconsumerorder80
│      │              ├─config
│      │              └─controller
│      ├─generated-sources
│      │  └─annotations
│      ├─generated-test-sources
│      │  └─test-annotations
│      └─test-classes
│          └─com
│              └─example
│                  └─cloudconsumerorder80
└─cloud-provider-payment8001
    └─src
        ├─main
        │  ├─java
        │  │  └─com
        │  │      └─Project
        │  │          ├─config
        │  │          ├─controller
        │  │          ├─mapper
        │  │          └─service
        │  │              └─impl
        │  └─resources
        │      └─mapper
        └─test
            └─java
```

### 最终pom文件

- 父文件

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <!--    设置打包名称-->
    <packaging>pom</packaging>
    <modules>
        <module>cloud-provider-payment8001</module>
        <module>cloud-api-commons</module>
    </modules>

    <groupId>com.amayakite</groupId>
    <artifactId>30-cloud</artifactId>
    <version>1.0-SNAPSHOT</version>

    <!--    统一管理Jar包版本-->
    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <spring.cloud-version>2020.0.5</spring.cloud-version>
        <spring.boot.version>2.5.8</spring.boot.version>
        <spring.boot.alibaba.version>2021.1</spring.boot.alibaba.version>
        <mysql.version>8.0.27</mysql.version>
        <druid-spring-boot-starter.version>1.2.8</druid-spring-boot-starter.version>
        <junit.version>5.8.2</junit.version>
        <mybatis.plus.version>3.4.3.4</mybatis.plus.version>
        <lombok.version>1.18.22</lombok.version>
        <springfox-swagger.version>3.0.0</springfox-swagger.version>
    </properties>


    <!--    引入依赖dependencyManagement 是锁定版本 让子工程不用写groupId和version -->
    <dependencyManagement>
        <dependencies>
            <!--            spring boot 版本控制-->
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-parent</artifactId>
                <version>${spring.boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <!--            spring cloud 版本控制-->
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring.cloud-version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>${spring.boot.alibaba.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>mysql</groupId>
                <artifactId>mysql-connector-java</artifactId>
                <version>${mysql.version}</version>
            </dependency>
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>druid-spring-boot-starter</artifactId>
                <version>${druid-spring-boot-starter.version}</version>
            </dependency>
            <dependency>
                <groupId>com.baomidou</groupId>
                <artifactId>mybatis-plus-boot-starter</artifactId>
                <version>${mybatis.plus.version}</version>
            </dependency>
            <!--junit-->
            <dependency>
                <groupId>org.junit.jupiter</groupId>
                <artifactId>junit-jupiter</artifactId>
                <version>${junit.version}</version>
                <scope>test</scope>
            </dependency>
            <dependency>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
                <version>${lombok.version}</version>
            </dependency>
            <dependency>
                <groupId>io.springfox</groupId>
                <artifactId>springfox-boot-starter</artifactId>
                <version>${springfox-swagger.version}</version>
            </dependency>
        </dependencies>



    </dependencyManagement>

</project>
```

- 公共资源API

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>30-cloud</artifactId>
        <groupId>com.amayakite</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>cloud-api-commons</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>

    <dependencies>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>5.7.18</version>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-annotations</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-web</artifactId>
        </dependency>
    </dependencies>


</project>
```

- 下单中心

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>30-cloud</artifactId>
        <groupId>com.amayakite</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>cloud-provider-payment8001</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!--        注意这个玩意 后面非常重要 通常和web一块出现-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid-spring-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jdbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
        </dependency>
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>com.amayakite</groupId>
            <artifactId>cloud-api-commons</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
<!--        <dependency>-->
<!--            <groupId>com.github.xiaoymin</groupId>-->
<!--            <artifactId>swagger-bootstrap-ui</artifactId>-->
<!--            <version>1.9.6</version>-->
<!--        </dependency>-->
    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <fork>true</fork>
                    <addResources>true</addResources>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
```

- 客户操作

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>30-cloud</artifactId>
        <groupId>com.amayakite</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <artifactId>cloud-consumer-order-80</artifactId>
    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-configuration-processor</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>com.amayakite</groupId>
            <artifactId>cloud-api-commons</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>

```

### 准备工作-结束

到这里为止 我们只是将准备工作做好了，微服务还没有正式的开始..

我们目前实现了简单的基于HTTP的数据传输

接下来我们将一步步的通过整合各个框架让我们的功能变得更便捷、强大
